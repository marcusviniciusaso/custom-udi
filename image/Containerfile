ARG UDI_IMAGE=registry.redhat.io/devspaces/udi-rhel9:3.22

FROM ${UDI_IMAGE}

USER 0

ARG OCP_VERSION=4.18.24
ARG HELM_VERSION=v3.16.2
ARG KIND_VERSION=v0.26.0

RUN set -euo pipefail; \
    arch="${TARGETARCH:-}"; \
    if [ -z "$arch" ]; then \
      uarch="$(uname -m)"; \
      case "$uarch" in \
        x86_64) arch="amd64" ;; \
        aarch64|arm64) arch="arm64" ;; \
        *) echo "Unsupported arch: $uarch" && exit 1 ;; \
      esac; \
    fi; \
    echo "$arch" > /tmp/ARCH

# Nao encontrado: traceroute redhat-lsb-core
# Conflito: curl
RUN set -euo pipefail; \
    PKGS="gnupg2 ca-certificates unzip zip jq git tree bash-completion iputils vim-enhanced"; \
    if command -v microdnf >/dev/null 2>&1; then \
      microdnf install -y $PKGS && microdnf clean all; \
    else \
      dnf install -y $PKGS && dnf clean all; \
    fi

# ---- Azure CLI ----
RUN set -euo pipefail; \
    rpm --import https://packages.microsoft.com/keys/microsoft.asc; \
    if command -v dnf >/dev/null 2>&1; then \
      dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm; \
      dnf install -y azure-cli; \
      dnf clean all; \
    else \
      echo "dnf não encontrado; ajuste a base ou instale azure-cli manualmente." && exit 1; \
    fi

# ---- oc + kubectl ----
RUN set -euo pipefail; \
    curl -fsSL -o /tmp/ocp-client.tar.gz \
      "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable-4.18/openshift-client-linux.tar.gz"; \
    tar -C /tmp -xzf /tmp/ocp-client.tar.gz; \
    install -m 0755 /tmp/oc /usr/local/bin/oc; \
    if [ -f /tmp/kubectl ]; then install -m 0755 /tmp/kubectl /usr/local/bin/kubectl; fi; \
    rm -rf /tmp/oc /tmp/kubectl /tmp/README.md /tmp/ocp-client.tar.gz

# ---- helm ----
RUN set -euo pipefail; \
    arch="$(cat /tmp/ARCH)"; \
    curl -fsSL -o /tmp/helm.tgz \
      "https://get.helm.sh/helm-${HELM_VERSION}-linux-${arch}.tar.gz"; \
    tar -C /tmp -xzf /tmp/helm.tgz; \
    install -m 0755 "/tmp/linux-${arch}/helm" /usr/local/bin/helm; \
    rm -rf /tmp/helm.tgz "/tmp/linux-${arch}"

# ---- kind ----
RUN set -euo pipefail; \
    arch="$(cat /tmp/ARCH)"; \
    curl -fsSL -o /usr/local/bin/kind \
      "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-${arch}"; \
    chmod 0755 /usr/local/bin/kind

# ---- CEKit ----
RUN set -euo pipefail; \
    if command -v pip3 >/dev/null 2>&1; then \
      pip3 install --no-cache-dir -U cekit; \
    else \
      echo "pip3 não encontrado; instale python3-pip na base ou ajuste a imagem." && exit 1; \
    fi

# ---- podman ----
RUN set -euo pipefail; \
    if ! command -v podman >/dev/null 2>&1; then \
      if command -v dnf >/dev/null 2>&1; then dnf install -y podman && dnf clean all; \
      else echo "podman ausente e dnf indisponível" && exit 1; fi; \
    fi

RUN set -euo pipefail; \
    mkdir -p /etc/bash_completion.d; \
    (kubectl completion bash > /etc/bash_completion.d/kubectl || true); \
    (oc completion bash > /etc/bash_completion.d/oc || true); \
    (helm completion bash > /etc/bash_completion.d/helm || true)

# ---- nota de versao ----
RUN set -euo pipefail; \
    cat > /etc/devspaces-linux-release <<'EOF'
devspaces_distro:
  type: base
  version: "1.0.0"
  release_date: "2026-01-16"
os:
  name: "Red Hat Enterprise Linux"
  version: "x"
EOF
RUN chmod 0644 /etc/devspaces-linux-release

LABEL org.opencontainers.image.title="Dev Spaces Custom UDI" \
      org.opencontainers.image.description="UDI customizada para Dev Spaces 3.22" \
      org.opencontainers.image.source="https://github.com/marcusviniciusaso/custom-udi" \
      org.opencontainers.image.vendor="Red Hat (sample)" \
      org.opencontainers.image.version="1.0.0"

USER 10001

CMD ["bash", "-lc", "sleep infinity"]
